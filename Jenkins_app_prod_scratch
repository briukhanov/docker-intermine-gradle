pipeline {

  agent {
    label "master"
  }
  options {
       buildDiscarder(logRotator(numToKeepStr: '7', artifactNumToKeepStr: '7'))
     }

  environment {
    AWS_CRED=credentials('AWS-pipeline')
    AWS_ACCESS_KEY_ID = "${env.AWS_CRED_USR}"
    AWS_SECRET_ACCESS_KEY = "${env.AWS_CRED_PSW}"
    DOC_HUB=credentials('DockerHub-wibob')
    app_dns=''
  }


  stages {
        stage ('checkout infra git') {
            steps {
                    git url: 'https://github.com/briukhanov/epam_lab_final.git',
                    // credentialsId: 'github-ssh-key',
                    branch: 'master'

            }
        }

        stage('Getting app address') {

            steps { dir ('terraform') {
                sh '''
                terraform init -input=false -force-copy
                terraform workspace select prod
                '''
                script {
                sshagent(credentials : ['wibob-Frankfurt-ubuntu']) {
                  tmp_param =  sh (script: 'terraform output web_server_public_dns', returnStdout: true).trim()
                  app_dns = tmp_param
                  env.app_dns = app_dns

                }
                }
                }
              }
          }




        stage('Chckout Repo on app_instance') {
              steps {

                sshagent(credentials : ['wibob-Frankfurt-ubuntu']) {
                    sh "ssh -o StrictHostKeyChecking=no ubuntu@${app_dns} git clone https://github.com/briukhanov/docker-intermine-gradle.git"
                }
              }
              }


        stage('Build And Deploy From Repo') {
              steps {

                sshagent(credentials : ['wibob-Frankfurt-ubuntu']) {
                    sh """
                    echo "Deploy Complete"
                    // ssh -o StrictHostKeyChecking=no ubuntu@${app_dns} "cd ~/docker-intermine-gradle && sudo docker-compose -f build.docker-compose.yml up --build --force-recreate"
                    """
                }

              }
        }
      }
    }
