pipeline {

  agent {
    label "master"
  }
  options {
       buildDiscarder(logRotator(numToKeepStr: '7', artifactNumToKeepStr: '7'))
     }

  environment {
    AWS_CRED=credentials('AWS-pipeline')
    AWS_ACCESS_KEY_ID = "${env.AWS_CRED_USR}"
    AWS_SECRET_ACCESS_KEY = "${env.AWS_CRED_PSW}"
    DOC_HUB=credentials('DockerHub-wibob')
  }

  parameters {
              string(name: 'app_dns', defaultValue: '12')
            }
  stages {
        stage ('checkout infra git') {
            steps {
                    git url: 'https://github.com/briukhanov/epam_lab_final.git',
                    // credentialsId: 'github-ssh-key',
                    branch: 'master'

            }
        }

        stage('Getting app address') {

            steps { dir ('terraform') {
                sh '''
                terraform init -input=false -force-copy
                terraform workspace select dev
                '''
                script {
                sshagent(credentials : ['wibob-Frankfurt-ubuntu']) {
                  tmp_param =  sh (script: 'terraform output web_server_public_dns', returnStdout: true).trim()
                  env.app_dns = tmp_param
                  // sh '''
                  // APP_DNS=`terraform output web_server_public_dns`
                  // ssh -o StrictHostKeyChecking=no ubuntu@$APP_DNS "ls"
                  // '''
                }
                }
                }
              }
          }

          // stage('Install Perl Libs') {
          //   steps { dir ('terraform') {
          //     sshagent(credentials : ['wibob-Frankfurt-ubuntu']) {
          //       sh '''
          //       APP_DNS=`terraform output web_server_public_dns`
          //       ssh -o StrictHostKeyChecking=no ubuntu@$APP_DNS "sudo ~/ansible/roles/build_dep/files/perl_lib.sh"
          //       '''
          //     }
          //     }
          //   }
          // }
        stage('Chckout Repo on app_instance') {
              steps {

                sshagent(credentials : ['wibob-Frankfurt-ubuntu']) {
                    sh '''
                    ssh -o StrictHostKeyChecking=no ubuntu@"${env.app_dns}" git clone https://github.com/briukhanov/docker-intermine-gradle.git
                    '''
                }
              }
              }

        stage('Build Docker Images') {
              steps {
                script {
                sshagent(credentials : ['wibob-Frankfurt-ubuntu']) {
                    sh '''
                    ssh -o StrictHostKeyChecking=no ubuntu@${env.app_dns} "cd ~/docker-intermine-gradle && sudo docker-compose -f buil.docker-compose.yml build --parallel"
                    '''
                }
              }
              }
        }

        stage('Pushing to DockerHub') {
              steps {
                script {
                sshagent(credentials : ['wibob-Frankfurt-ubuntu']) {
                    sh '''
                    ssh -o StrictHostKeyChecking=no ubuntu@${env.app_dns} "docker login -u ${env.DOC_HUB_USR} -p ${env.DOC_HUB_PSW} && \
                    docker commit intermine_builder wibob/builder:$BUILD_NUMBER && \
                    docker tag wibob/builder:$BUILD_NUMBER wibob/builder:latest && \
                    docker commit intermine_postgres wibob/postgres:$BUILD_NUMBER && \
                    docker tag wibob/postgres:$BUILD_NUMBER wibob/postgres:latest && \
                    docker commit intermine_tomcat wibob/tomcat:$BUILD_NUMBER && \
                    docker tag wwibob/tomcat:$BUILD_NUMBER wibob/tomcat:latest && \
                    docker push wibob/builder && \
                    docker push wibob/postgres && \
                    docker push wibob/tomcat"
                    '''
                }
                }
              }
        }
        stage('Deploy') {
            steps {
              sh 'echo Deploy complete'
            }
        }
      }
    }
